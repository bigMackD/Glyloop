<div class="add-event-modal-overlay" [class.open]="open()" (click)="onClose()" data-testid="add-event-dialog">
  <div class="modal-content" (click)="$event.stopPropagation()" role="dialog" [attr.aria-modal]="true" [attr.aria-labelledby]="'modal-title'">
    <!-- Header -->
    <div class="modal-header">
      <h2 id="modal-title" class="text-xl font-semibold" data-testid="add-event-title">{{ title }}</h2>
      <button mat-icon-button (click)="onClose()" [attr.aria-label]="cancelLabel" data-testid="add-event-close-button">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- Error Banner -->
    @if (error()) {
      <div class="error-banner" data-testid="add-event-error-message">
        <mat-icon>error</mat-icon>
        <span>{{ error() }}</span>
      </div>
    }

    <!-- Tabs -->
    <mat-tab-group
      [selectedIndex]="activeTabIndex()"
      (selectedIndexChange)="onTabChange($event)"
      class="event-tabs"
      data-testid="event-tabs"
    >
      <!-- Food Tab -->
      <mat-tab [label]="foodTab" data-testid="food-tab">
        <form [formGroup]="foodForm" class="event-form" data-testid="food-form">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>{{ carbsLabel }}</mat-label>
            <input
              matInput
              type="number"
              formControlName="carbohydratesGrams"
              [attr.aria-label]="carbsLabel"
              data-testid="food-carbs-input"
              min="0"
              max="300"
              step="1"
            />
            @if (foodForm.controls.carbohydratesGrams.hasError('required')) {
              <mat-error i18n="@@dashboard.addEvent.food.carbs.required">Carbs are required</mat-error>
            }
            @if (
              foodForm.controls.carbohydratesGrams.hasError('min') ||
              foodForm.controls.carbohydratesGrams.hasError('max')
            ) {
              <mat-error i18n="@@dashboard.addEvent.food.carbs.range">Must be between 0 and 300</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>{{ mealTagLabel }}</mat-label>
            <mat-select formControlName="mealTagId">
              <mat-option [value]="null">None</mat-option>
              @for (tag of mealTags; track tag.id) {
                <mat-option [value]="tag.id">{{ tag.label }}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>{{ absorptionLabel }}</mat-label>
            <mat-select formControlName="absorptionHint">
              <mat-option [value]="''">None</mat-option>
              @for (hint of absorptionHints; track hint) {
                <mat-option [value]="hint">{{ hint }}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>{{ noteLabel }}</mat-label>
            <textarea
              matInput
              formControlName="note"
              rows="3"
              maxlength="500"
            ></textarea>
            <mat-hint align="end">{{ foodForm.controls.note.value?.length || 0 }}/500</mat-hint>
          </mat-form-field>
        </form>
      </mat-tab>

      <!-- Insulin Tab -->
      <mat-tab [label]="insulinTab" data-testid="insulin-tab">
        <form [formGroup]="insulinForm" class="event-form" data-testid="insulin-form">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>{{ insulinTypeLabel }}</mat-label>
            <mat-select formControlName="insulinType" data-testid="insulin-type-select">
              @for (type of insulinTypes; track type) {
                <mat-option [value]="type">{{ type }}</mat-option>
              }
            </mat-select>
            @if (insulinForm.controls.insulinType.hasError('required')) {
              <mat-error i18n="@@dashboard.addEvent.insulin.type.required">Type is required</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>{{ insulinUnitsLabel }}</mat-label>
            <input
              matInput
              type="number"
              formControlName="insulinUnits"
              [attr.aria-label]="insulinUnitsLabel"
              data-testid="insulin-units-input"
              min="0"
              max="100"
              step="0.5"
            />
            @if (insulinForm.controls.insulinUnits.hasError('required')) {
              <mat-error i18n="@@dashboard.addEvent.insulin.units.required">Units are required</mat-error>
            }
            @if (
              insulinForm.controls.insulinUnits.hasError('min') ||
              insulinForm.controls.insulinUnits.hasError('max')
            ) {
              <mat-error i18n="@@dashboard.addEvent.insulin.units.range">Must be between 0 and 100</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>{{ preparationLabel }}</mat-label>
            <mat-select formControlName="preparation">
              <mat-option [value]="''">None</mat-option>
              @for (prep of insulinPreparations; track prep) {
                <mat-option [value]="prep">{{ prep }}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>{{ deliveryLabel }}</mat-label>
            <mat-select formControlName="delivery">
              <mat-option [value]="''">None</mat-option>
              @for (del of insulinDeliveries; track del) {
                <mat-option [value]="del">{{ del }}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>{{ timingLabel }}</mat-label>
            <mat-select formControlName="timing">
              <mat-option [value]="''">None</mat-option>
              @for (time of insulinTimings; track time) {
                <mat-option [value]="time">{{ time }}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>{{ noteLabel }}</mat-label>
            <textarea
              matInput
              formControlName="note"
              rows="3"
              maxlength="500"
            ></textarea>
            <mat-hint align="end">{{ insulinForm.controls.note.value?.length || 0 }}/500</mat-hint>
          </mat-form-field>
        </form>
      </mat-tab>

      <!-- Exercise Tab -->
      <mat-tab [label]="exerciseTab" data-testid="exercise-tab">
        <form [formGroup]="exerciseForm" class="event-form" data-testid="exercise-form">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>{{ exerciseTypeLabel }}</mat-label>
            <mat-select formControlName="exerciseTypeId">
              @for (type of exerciseTypes; track type.id) {
                <mat-option [value]="type.id">{{ type.label }}</mat-option>
              }
            </mat-select>
            @if (exerciseForm.controls.exerciseTypeId.hasError('required')) {
              <mat-error i18n="@@dashboard.addEvent.exercise.type.required">Type is required</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>{{ durationLabel }}</mat-label>
            <input
              matInput
              type="number"
              formControlName="durationMinutes"
              [attr.aria-label]="durationLabel"
              min="1"
              max="300"
              step="1"
            />
            @if (exerciseForm.controls.durationMinutes.hasError('required')) {
              <mat-error i18n="@@dashboard.addEvent.exercise.duration.required">Duration is required</mat-error>
            }
            @if (
              exerciseForm.controls.durationMinutes.hasError('min') ||
              exerciseForm.controls.durationMinutes.hasError('max')
            ) {
              <mat-error i18n="@@dashboard.addEvent.exercise.duration.range">Must be between 1 and 300</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>{{ intensityLabel }}</mat-label>
            <mat-select formControlName="intensity">
              <mat-option [value]="''">None</mat-option>
              @for (int of intensities; track int) {
                <mat-option [value]="int">{{ int }}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>{{ exerciseNoteLabel }}</mat-label>
            <textarea
              matInput
              formControlName="note"
              rows="3"
              maxlength="500"
            ></textarea>
            <mat-hint align="end">{{ exerciseForm.controls.note.value?.length || 0 }}/500</mat-hint>
          </mat-form-field>
        </form>
      </mat-tab>

      <!-- Note Tab -->
      <mat-tab [label]="noteTab" data-testid="note-tab">
        <form [formGroup]="noteForm" class="event-form" data-testid="note-form">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>{{ noteLabel }}</mat-label>
            <textarea
              matInput
              formControlName="noteText"
              rows="5"
              maxlength="500"
            ></textarea>
            @if (noteForm.controls.noteText.hasError('required')) {
              <mat-error i18n="@@dashboard.addEvent.note.required">Note is required</mat-error>
            }
            <mat-hint align="end">{{ noteForm.controls.noteText.value?.length || 0 }}/500</mat-hint>
          </mat-form-field>
        </form>
      </mat-tab>
    </mat-tab-group>

    <!-- Footer Actions -->
    <div class="modal-footer">
      <button mat-stroked-button (click)="onClose()" [disabled]="isSubmitting()" data-testid="add-event-cancel-button">
        {{ cancelLabel }}
      </button>
      <button
        mat-raised-button
        color="primary"
        (click)="onSubmit()"
        [disabled]="isSubmitting() || getCurrentForm().invalid"
        data-testid="add-event-submit-button"
      >
        @if (isSubmitting()) {
          <mat-spinner diameter="20" class="inline-spinner"></mat-spinner>
        }
        {{ submitLabel }}
      </button>
    </div>
  </div>
</div>
